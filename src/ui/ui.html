<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>Figmaãƒ—ãƒ©ã‚°ã‚¤ãƒ³é€šä¿¡ãƒ†ã‚¹ãƒˆ</title>
    <style>
      .status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 5px;
      }
      .status-connected {
        background-color: #4caf50; /* ç·‘è‰² */
      }
      .status-disconnected {
        background-color: #f44336; /* èµ¤è‰² */
      }
      .status-checking {
        background-color: #ffc107; /* é»„è‰² */
      }
      .status-container {
        margin-bottom: 10px;
        padding: 5px;
        border: 1px solid #ccc;
        border-radius: 4px;
      }
    </style>
  </head>
  <body>
    <div class="status-container">
      <div>
        <span class="status-indicator status-checking" id="server-status-indicator"></span>
        <span id="server-status-text">ã‚µãƒ¼ãƒãƒ¼æ¥ç¶šçŠ¶æ…‹: ç¢ºèªä¸­...</span>
      </div>
      <div>
        <small>URL: http://localhost:3000</small>
      </div>
    </div>
    <button id="test-button">ãƒ†ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡</button>
    <textarea id="log-area" rows="10" cols="50" readonly></textarea>
    <script>
      // ãƒ‡ãƒãƒƒã‚°ç”¨ã®ãƒ­ã‚°é–¢æ•°
      function log(message) {
        const logArea = document.getElementById("log-area");
        if (logArea) {
          logArea.value += message + "\n";
          console.log(message);
        }
      }

      // ã‚µãƒ¼ãƒãƒ¼æ¥ç¶šçŠ¶æ…‹ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
      function updateServerStatus(status, message) {
        const indicator = document.getElementById("server-status-indicator");
        const statusText = document.getElementById("server-status-text");

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã®ã‚¯ãƒ©ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ
        indicator.classList.remove("status-connected", "status-disconnected", "status-checking");

        // æ–°ã—ã„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«å¿œã˜ã¦ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
        if (status === "connected") {
          indicator.classList.add("status-connected");
          statusText.textContent = "ã‚µãƒ¼ãƒãƒ¼æ¥ç¶šçŠ¶æ…‹: æ¥ç¶šæ¸ˆã¿";
        } else if (status === "disconnected") {
          indicator.classList.add("status-disconnected");
          statusText.textContent = "ã‚µãƒ¼ãƒãƒ¼æ¥ç¶šçŠ¶æ…‹: æœªæ¥ç¶š";
          if (message) {
            statusText.textContent += ` (${message})`;
          }
        } else {
          indicator.classList.add("status-checking");
          statusText.textContent = "ã‚µãƒ¼ãƒãƒ¼æ¥ç¶šçŠ¶æ…‹: ç¢ºèªä¸­...";
        }
      }

      // ã‚µãƒ¼ãƒãƒ¼æ¥ç¶šçŠ¶æ…‹ã‚’ç¢ºèªã™ã‚‹é–¢æ•°
      async function checkServerConnection() {
        updateServerStatus("checking");
        log("ğŸ” UI: ã‚µãƒ¼ãƒãƒ¼æ¥ç¶šçŠ¶æ…‹ã‚’ç¢ºèªã—ã¦ã„ã¾ã™...");

        try {
          const response = await fetch("http://localhost:3000/status", {
            method: "GET",
            headers: {
              Accept: "application/json",
            },
            mode: "cors",
            cache: "no-cache",
            timeout: 5000,
          });

          if (response.ok) {
            const data = await response.json();
            log(`ğŸ” UI: ã‚µãƒ¼ãƒãƒ¼æ¥ç¶šæˆåŠŸ: ${JSON.stringify(data)}`);
            updateServerStatus("connected");
            return true;
          } else {
            log(`âŒ UI: ã‚µãƒ¼ãƒãƒ¼æ¥ç¶šã‚¨ãƒ©ãƒ¼: ${response.status} ${response.statusText}`);
            updateServerStatus("disconnected", `${response.status} ${response.statusText}`);
            return false;
          }
        } catch (error) {
          log(`âŒ UI: ã‚µãƒ¼ãƒãƒ¼æ¥ç¶šã‚¨ãƒ©ãƒ¼: ${error.message}`);

          // æ¥ç¶šæ‹’å¦ã‚¨ãƒ©ãƒ¼ã®å ´åˆã€ã‚µãƒ¼ãƒãƒ¼èµ·å‹•æ–¹æ³•ã‚’è¡¨ç¤º
          if (
            error.message.includes("Connection refused") ||
            error.message.includes("Failed to fetch")
          ) {
            const errorMessage =
              "ã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ã¦ã„ã¾ã›ã‚“ã€‚ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã—ã¦ãã ã•ã„ï¼š";
            const startCommand = "cd server && npm start -- --api-key=YOUR_API_KEY";
            log(`âŒ UI: ${errorMessage}`);
            log(`ğŸ”§ UI: ${startCommand}`);
            updateServerStatus("disconnected", "ã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ã¦ã„ã¾ã›ã‚“");
          } else {
            updateServerStatus("disconnected", error.message);
          }

          return false;
        }
      }

      // å®šæœŸçš„ã«ã‚µãƒ¼ãƒãƒ¼æ¥ç¶šçŠ¶æ…‹ã‚’ç¢ºèª
      function startServerStatusCheck() {
        // åˆå›ç¢ºèª
        checkServerConnection();

        // 10ç§’ã”ã¨ã«ç¢ºèª
        setInterval(checkServerConnection, 10000);
      }

      // ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒèª­ã¿è¾¼ã¾ã‚ŒãŸã“ã¨ã‚’ãƒ­ã‚°ã«è¨˜éŒ²
      log("ğŸ” UI: ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒèª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸ");

      // ãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³ã®å–å¾—
      const testButton = document.getElementById("test-button");
      log("ğŸ” UI: ãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³ã‚’å–å¾—ã—ã¾ã—ãŸ: " + (testButton ? "æˆåŠŸ" : "å¤±æ•—"));

      // ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
      if (testButton) {
        testButton.addEventListener("click", () => {
          log("ğŸ” UI: ãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ");

          try {
            const message = { pluginMessage: { type: "test-message" } };
            log(`ğŸ” UI: é€ä¿¡ã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: ${JSON.stringify(message)}`);

            // Figmaãƒ—ãƒ©ã‚°ã‚¤ãƒ³ç’°å¢ƒã§ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
            parent.postMessage(message, "*");
            log("ğŸ” UI: parent.postMessageã‚’ä½¿ç”¨ã—ã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡å®Œäº†");
          } catch (error) {
            log(`âŒ UI: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã‚¨ãƒ©ãƒ¼: ${error}`);
          }
        });
      } else {
        log("âŒ UI: ãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
      }

      // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
      window.onmessage = (event) => {
        log("ğŸ” UI: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¤ãƒ™ãƒ³ãƒˆã‚’å—ä¿¡ã—ã¾ã—ãŸ");
        log(`ğŸ” UI: event.data: ${JSON.stringify(event.data)}`);

        // Figmaãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã©ã†ã‹ã‚’ç¢ºèª
        if (!event.data.pluginMessage) {
          log("âŒ UI: Figmaãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§ã¯ã‚ã‚Šã¾ã›ã‚“");
          return;
        }

        const message = event.data.pluginMessage;
        log(`ğŸ” UI: pluginMessage: ${JSON.stringify(message)}`);
        log(`ğŸ” UI: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¿ã‚¤ãƒ—: ${message.type}`);
      };

      // ã‚µãƒ¼ãƒãƒ¼æ¥ç¶šçŠ¶æ…‹ã®ç¢ºèªã‚’é–‹å§‹
      startServerStatusCheck();

      log("ğŸ” UI: UIã®åˆæœŸåŒ–ãŒå®Œäº†ã—ã¾ã—ãŸ");
    </script>
  </body>
</html>

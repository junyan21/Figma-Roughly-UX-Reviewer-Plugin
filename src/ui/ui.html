<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>Figmaプラグイン通信テスト</title>
    <style>
      .status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 5px;
      }
      .status-connected {
        background-color: #4caf50; /* 緑色 */
      }
      .status-disconnected {
        background-color: #f44336; /* 赤色 */
      }
      .status-checking {
        background-color: #ffc107; /* 黄色 */
      }
      .status-container {
        margin-bottom: 10px;
        padding: 5px;
        border: 1px solid #ccc;
        border-radius: 4px;
      }
    </style>
  </head>
  <body>
    <div class="status-container">
      <div>
        <span class="status-indicator status-checking" id="server-status-indicator"></span>
        <span id="server-status-text">サーバー接続状態: 確認中...</span>
      </div>
      <div>
        <small>URL: http://localhost:3000</small>
      </div>
    </div>
    <button id="test-button">テストメッセージ送信</button>
    <textarea id="log-area" rows="10" cols="50" readonly></textarea>
    <script>
      // デバッグ用のログ関数
      function log(message) {
        const logArea = document.getElementById("log-area");
        if (logArea) {
          logArea.value += message + "\n";
          console.log(message);
        }
      }

      // サーバー接続状態を更新する関数
      function updateServerStatus(status, message) {
        const indicator = document.getElementById("server-status-indicator");
        const statusText = document.getElementById("server-status-text");

        // ステータスインジケーターのクラスをリセット
        indicator.classList.remove("status-connected", "status-disconnected", "status-checking");

        // 新しいステータスに応じてクラスを追加
        if (status === "connected") {
          indicator.classList.add("status-connected");
          statusText.textContent = "サーバー接続状態: 接続済み";
        } else if (status === "disconnected") {
          indicator.classList.add("status-disconnected");
          statusText.textContent = "サーバー接続状態: 未接続";
          if (message) {
            statusText.textContent += ` (${message})`;
          }
        } else {
          indicator.classList.add("status-checking");
          statusText.textContent = "サーバー接続状態: 確認中...";
        }
      }

      // サーバー接続状態を確認する関数
      async function checkServerConnection() {
        updateServerStatus("checking");
        log("🔍 UI: サーバー接続状態を確認しています...");

        try {
          const response = await fetch("http://localhost:3000/status", {
            method: "GET",
            headers: {
              Accept: "application/json",
            },
            mode: "cors",
            cache: "no-cache",
            timeout: 5000,
          });

          if (response.ok) {
            const data = await response.json();
            log(`🔍 UI: サーバー接続成功: ${JSON.stringify(data)}`);
            updateServerStatus("connected");
            return true;
          } else {
            log(`❌ UI: サーバー接続エラー: ${response.status} ${response.statusText}`);
            updateServerStatus("disconnected", `${response.status} ${response.statusText}`);
            return false;
          }
        } catch (error) {
          log(`❌ UI: サーバー接続エラー: ${error.message}`);

          // 接続拒否エラーの場合、サーバー起動方法を表示
          if (
            error.message.includes("Connection refused") ||
            error.message.includes("Failed to fetch")
          ) {
            const errorMessage =
              "サーバーが起動していません。以下のコマンドでサーバーを起動してください：";
            const startCommand = "cd server && npm start -- --api-key=YOUR_API_KEY";
            log(`❌ UI: ${errorMessage}`);
            log(`🔧 UI: ${startCommand}`);
            updateServerStatus("disconnected", "サーバーが起動していません");
          } else {
            updateServerStatus("disconnected", error.message);
          }

          return false;
        }
      }

      // 定期的にサーバー接続状態を確認
      function startServerStatusCheck() {
        // 初回確認
        checkServerConnection();

        // 10秒ごとに確認
        setInterval(checkServerConnection, 10000);
      }

      // スクリプトが読み込まれたことをログに記録
      log("🔍 UI: スクリプトが読み込まれました");

      // テストボタンの取得
      const testButton = document.getElementById("test-button");
      log("🔍 UI: テストボタンを取得しました: " + (testButton ? "成功" : "失敗"));

      // ボタンクリックイベントリスナーの設定
      if (testButton) {
        testButton.addEventListener("click", () => {
          log("🔍 UI: テストボタンがクリックされました");

          try {
            const message = { pluginMessage: { type: "test-message" } };
            log(`🔍 UI: 送信するメッセージ: ${JSON.stringify(message)}`);

            // Figmaプラグイン環境でのメッセージ送信
            parent.postMessage(message, "*");
            log("🔍 UI: parent.postMessageを使用してメッセージ送信完了");
          } catch (error) {
            log(`❌ UI: メッセージ送信エラー: ${error}`);
          }
        });
      } else {
        log("❌ UI: テストボタンが見つかりません");
      }

      // メッセージ受信イベントリスナーの設定
      window.onmessage = (event) => {
        log("🔍 UI: メッセージイベントを受信しました");
        log(`🔍 UI: event.data: ${JSON.stringify(event.data)}`);

        // Figmaプラグインからのメッセージかどうかを確認
        if (!event.data.pluginMessage) {
          log("❌ UI: Figmaプラグインからのメッセージではありません");
          return;
        }

        const message = event.data.pluginMessage;
        log(`🔍 UI: pluginMessage: ${JSON.stringify(message)}`);
        log(`🔍 UI: メッセージタイプ: ${message.type}`);
      };

      // サーバー接続状態の確認を開始
      startServerStatusCheck();

      log("🔍 UI: UIの初期化が完了しました");
    </script>
  </body>
</html>
